<!-- lala_app/templates/lala_app/resenas.html -->
{% extends 'lala_app/base.html' %}
{% load static %}

{% block content %}
<div class="reviews-page-container">
    <div class="container">
        <h1>‚≠ê Rese√±as de Nuestros Clientes</h1>
        
        <!-- Estad√≠sticas de rese√±as -->
        <div class="reviews-stats">
            <h2>üìä Resumen de Rese√±as</h2>
            <div class="stats-overview">
                <div class="stat-item">
                    <div class="stat-number">{{ rese√±as.count }}</div>
                    <div class="stat-label">Total de Rese√±as</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">
                        {% if rese√±as %}
                            {{ rese√±as|length }}
                        {% else %}
                            0
                        {% endif %}
                    </div>
                    <div class="stat-label">Rese√±as Activas</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">
                        {% if productos_con_resenas %}
                            {{ productos_con_resenas|length }}
                        {% else %}
                            0
                        {% endif %}
                    </div>
                    <div class="stat-label">Productos con Rese√±as</div>
                </div>
            </div>
        </div>

        <!-- Productos mejor calificados -->
        {% if productos_info %}
        <div class="top-rated-products">
            <h2>üèÜ Productos Mejor Calificados</h2>
            <div class="products-stats-grid">
                {% for info in productos_info|slice:":6" %}
                <div class="product-stat-card">
                    <div class="product-image-small">
                        <a href="{% url 'detalle_producto' info.producto.id %}">
                            {% if info.producto.foto %}
                                <img src="{{ info.producto.foto.url }}" alt="{{ info.producto.nombre }}">
                            {% else %}
                                <img src="{% static 'lala_app/img/placeholder.jpg' %}" alt="Imagen no disponible">
                            {% endif %}
                        </a>
                    </div>
                    <div class="product-stat-info">
                        <h4><a href="{% url 'detalle_producto' info.producto.id %}">{{ info.producto.nombre }}</a></h4>
                        <div class="rating-average">
                            <span class="stars">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= info.promedio %}
                                        ‚òÖ
                                    {% else %}
                                        ‚òÜ
                                    {% endif %}
                                {% endfor %}
                            </span>
                            <span class="average">{{ info.promedio|floatformat:1 }}</span>
                        </div>
                        <p class="review-count">{{ info.total_resenas }} rese√±a{{ info.total_resenas|pluralize }}</p>
                        <a href="{% url 'detalle_producto' info.producto.id %}" class="btn-view-product">Ver Producto</a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Todas las rese√±as -->
        <div class="all-reviews-section">
            <div class="section-header">
                <h2>üí¨ Todas las Rese√±as</h2>
                
                {% if user.is_authenticated and not user.groups.all.0.name == 'Gerente' %}
                <div class="add-review-global">
                    <p>¬øQuieres compartir tu experiencia?</p>
                    <a href="{% url 'productos_lacteos' %}" class="btn-add-review-global">‚≠ê Escribir una Rese√±a</a>
                </div>
                {% endif %}
            </div>

            <div class="reviews-list">
                {% for resena in rese√±as %}
                <div class="review-item-card">
                    <div class="review-header">
                        <div class="reviewer-avatar">
                            {% if resena.cliente.foto_perfil %}
                                <img src="{{ resena.cliente.foto_perfil.url }}" alt="{{ resena.cliente.usuario.get_full_name }}">
                            {% else %}
                                <div class="avatar-placeholder">{{ resena.cliente.usuario.first_name|first|default:resena.cliente.usuario.username|first }}</div>
                            {% endif %}
                        </div>
                        <div class="reviewer-info">
                            <strong class="reviewer-name">{{ resena.cliente.usuario.get_full_name|default:resena.cliente.usuario.username }}</strong>
                            <span class="review-date">{{ resena.fecha|date:"d M Y" }}</span>
                        </div>
                        <div class="review-rating">
                            {% for i in "12345" %}
                                {% if forloop.counter <= resena.calificacion %}
                                    <span class="star filled">‚òÖ</span>
                                {% else %}
                                    <span class="star">‚òÜ</span>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="review-product-info">
                        <strong>Producto:</strong> 
                        <a href="{% url 'detalle_producto' resena.producto.id %}" class="product-link">{{ resena.producto.nombre }}</a>
                    </div>
                    
                    <div class="review-content">
                        <p>{{ resena.descripcion }}</p>
                    </div>
                    
                    {% if resena.foto_producto %}
                    <div class="review-image">
                        <img src="{{ resena.foto_producto.url }}" alt="Foto del producto" onclick="openImageModal(this.src)">
                    </div>
                    {% endif %}
                    
{% if user.is_authenticated and user == resena.cliente.usuario %}
<div class="review-actions">
    <a href="{% url 'agregar_resena' resena.producto.id %}" class="btn-edit-review">‚úèÔ∏è Editar Mi Rese√±a</a>
    <a href="{% url 'eliminar_resena' resena.id %}" class="btn-delete-review" style="text-decoration: none;">
        üóëÔ∏è Eliminar
    </a>
</div>
{% endif %}
                </div>
                {% empty %}
                <div class="no-reviews-found">
                    <div class="no-reviews-content">
                        <h3>üìù A√∫n no hay rese√±as</h3>
                        <p>¬°S√© el primero en compartir tu experiencia con nuestros productos!</p>
                        {% if user.is_authenticated %}
                        <a href="{% url 'productos_lacteos' %}" class="btn-primary">üìù Escribir mi primera rese√±a</a>
                        {% else %}
                        <a href="{% url 'login' %}" class="btn-primary">üîë Iniciar sesi√≥n para escribir una rese√±a</a>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Modal para imagen -->
<div id="imageModal" class="modal">
    <span class="close-modal">&times;</span>
    <img class="modal-content" id="modalImage">
</div>

<style>
.reviews-page-container {
    padding: 40px 20px;
    background: #f8f9fa;
    min-height: 100vh;
}

.reviews-stats {
    background: white;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.stats-overview {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.stat-item {
    text-align: center;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 10px;
}

.stat-number {
    font-size: 2.5em;
    font-weight: bold;
    color: #e74c3c;
    margin-bottom: 5px;
}

.stat-label {
    color: #7f8c8d;
    font-size: 0.9em;
}

.top-rated-products {
    background: white;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.products-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.product-stat-card {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    display: flex;
    gap: 15px;
    align-items: center;
    transition: transform 0.3s ease;
}

.product-stat-card:hover {
    transform: translateY(-5px);
}

.product-image-small {
    width: 80px;
    height: 80px;
    border-radius: 10px;
    overflow: hidden;
    flex-shrink: 0;
}

.product-image-small img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.product-stat-info {
    flex: 1;
}

.product-stat-info h4 {
    margin: 0 0 8px 0;
    font-size: 1.1em;
}

.product-stat-info h4 a {
    color: #2c3e50;
    text-decoration: none;
}

.product-stat-info h4 a:hover {
    color: #e74c3c;
}

.rating-average {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 5px;
}

.rating-average .stars {
    color: #f39c12;
    font-size: 1.1em;
}

.rating-average .average {
    font-weight: bold;
    color: #2c3e50;
    font-size: 1.1em;
}

.review-count {
    color: #7f8c8d;
    font-size: 0.9em;
    margin-bottom: 8px;
}

.btn-view-product {
    background: #3498db;
    color: white;
    padding: 6px 12px;
    border-radius: 5px;
    text-decoration: none;
    font-size: 0.85em;
    display: inline-block;
}

.all-reviews-section {
    background: white;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    flex-wrap: wrap;
    gap: 15px;
}

.add-review-global {
    text-align: center;
    padding: 15px;
    background: #e8f5e8;
    border-radius: 10px;
}

.btn-add-review-global {
    background: #27ae60;
    color: white;
    padding: 10px 20px;
    border-radius: 5px;
    text-decoration: none;
    display: inline-block;
    margin-top: 8px;
}

.reviews-list {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.review-item-card {
    background: #f8f9fa;
    padding: 25px;
    border-radius: 12px;
    border-left: 4px solid #3498db;
}

.review-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
}

.reviewer-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    overflow: hidden;
    flex-shrink: 0;
}

.reviewer-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.avatar-placeholder {
    width: 100%;
    height: 100%;
    background: #3498db;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.2em;
}

.reviewer-info {
    flex: 1;
}

.reviewer-name {
    color: #2c3e50;
    display: block;
    font-size: 1.1em;
}

.review-date {
    color: #7f8c8d;
    font-size: 0.85em;
}

.review-rating {
    color: #f39c12;
    font-size: 1.1em;
}

.review-product-info {
    margin-bottom: 12px;
    color: #7f8c8d;
}

.product-link {
    color: #3498db;
    text-decoration: none;
    font-weight: 500;
}

.review-content {
    color: #555;
    line-height: 1.6;
    margin-bottom: 15px;
}

.review-image img {
    max-width: 200px;
    border-radius: 8px;
    cursor: pointer;
    transition: transform 0.3s ease;
}

.review-image img:hover {
    transform: scale(1.05);
}

.review-actions {
    border-top: 1px solid #dee2e6;
    padding-top: 15px;
    margin-top: 15px;
    display: flex;
    gap: 15px;
    align-items: center;
    flex-wrap: wrap;
}

.btn-edit-review {
    background: #3498db;
    color: white;
    padding: 10px 20px;
    border-radius: 5px;
    text-decoration: none;
    font-size: 0.9em;
    display: inline-block;
}

.delete-form {
    display: inline;
}

.btn-delete-review {
    background: #e74c3c;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.9em;
}

.no-reviews-found {
    text-align: center;
    padding: 60px 20px;
}

.no-reviews-content h3 {
    color: #7f8c8d;
    margin-bottom: 15px;
}

.no-reviews-content p {
    color: #7f8c8d;
    margin-bottom: 25px;
    font-size: 1.1em;
}

.btn-primary {
    background: #3498db;
    color: white;
    padding: 12px 25px;
    border-radius: 5px;
    text-decoration: none;
    display: inline-block;
    font-size: 1.1em;
}

/* Modal styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.9);
}

.modal-content {
    display: block;
    margin: auto;
    max-width: 90%;
    max-height: 90%;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    border-radius: 10px;
}

.close-modal {
    position: absolute;
    top: 20px;
    right: 35px;
    color: white;
    font-size: 40px;
    font-weight: bold;
    cursor: pointer;
    z-index: 1001;
}

.close-modal:hover {
    color: #ccc;
}

/* Responsive */
@media (max-width: 768px) {
    .section-header {
        flex-direction: column;
        text-align: center;
    }
    
    .stats-overview {
        grid-template-columns: 1fr;
    }
    
    .products-stats-grid {
        grid-template-columns: 1fr;
    }
    
    .review-header {
        flex-direction: column;
        text-align: center;
        gap: 10px;
    }
    
    .reviewer-info {
        text-align: center;
    }
}
</style>

<script>
// Funcionalidad para el modal de im√°genes
function openImageModal(src) {
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImage');
    modal.style.display = 'block';
    modalImg.src = src;
}

function closeImageModal() {
    const modal = document.getElementById('imageModal');
    modal.style.display = 'none';
}

document.addEventListener('DOMContentLoaded', function() {
    // Cerrar modal al hacer clic en la X
    const closeBtn = document.querySelector('.close-modal');
    if (closeBtn) {
        closeBtn.addEventListener('click', closeImageModal);
    }
    
    // Cerrar modal al hacer clic fuera de la imagen
    const modal = document.getElementById('imageModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeImageModal();
            }
        });
    }
    
    // Cerrar modal con tecla ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeImageModal();
        }
    });
    
    // Animaci√≥n suave al cargar las rese√±as
    const reviewItems = document.querySelectorAll('.review-item-card');
    reviewItems.forEach((item, index) => {
        item.style.opacity = '0';
        item.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            item.style.transition = 'all 0.5s ease';
            item.style.opacity = '1';
            item.style.transform = 'translateY(0)';
        }, index * 100);
    });
});
</script>
{% endblock %}